{"remainingRequest":"D:\\phpstudy_pro\\WWW\\master\\view\\admin\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\phpstudy_pro\\WWW\\master\\view\\admin\\src\\components\\uploadPicture\\index.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\phpstudy_pro\\WWW\\master\\view\\admin\\src\\components\\uploadPicture\\index.vue","mtime":1612255397000},{"path":"D:\\phpstudy_pro\\WWW\\master\\view\\admin\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\phpstudy_pro\\WWW\\master\\view\\admin\\node_modules\\babel-loader\\lib\\index.js","mtime":315532800000},{"path":"D:\\phpstudy_pro\\WWW\\master\\view\\admin\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\phpstudy_pro\\WWW\\master\\view\\admin\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport {\n  formatLstApi,\n  attachmentCreateApi,\n  attachmentUpdateApi,\n  picNameEditApi,\n  attachmentDeleteApi,\n  attachmentListApi,\n  picDeleteApi,\n  categoryApi\n} from \"@/api/system\";\nimport { getToken } from \"@/utils/auth\";\nimport SettingMer from \"@/libs/settingMer\";\n\nexport default {\n  name: \"Upload\",\n  props: {\n    isMore: {\n      type: String,\n      default: \"1\"\n    }\n  },\n  data() {\n    return {\n      loading: false,\n      params: \"\",\n      sleOptions: {\n        attachment_category_name: \"\",\n        attachment_category_id: \"\"\n      },\n      list: [],\n      grid: {\n        xl: 8,\n        lg: 8,\n        md: 8,\n        sm: 8,\n        xs: 24\n      },\n      grid2: {\n        xl: 16,\n        lg: 16,\n        md: 16,\n        sm: 16,\n        xs: 24\n      },\n      filterText: \"\",\n      treeData: [],\n      treeData2: [],\n      defaultProps: {\n        children: \"children\",\n        label: \"attachment_category_name\"\n      },\n      classifyId: 0,\n      myHeaders: {\n        \"X-Token\": getToken()\n      },\n      tableData: {\n        page: 1,\n        limit: 12,\n        attachment_category_id: 0,\n        order: \"\",\n        attachment_name: \"\"\n      },\n      pictrueList: {\n        list: [],\n        total: 0\n      },\n      isShowPic: false,\n      checkPicList: [],\n      ids: [],\n      checkedMore: [],\n      checkedAll: [],\n      selectItem: [],\n      editId: \"\",\n      editName: \"\"\n    };\n  },\n  computed: {\n    fileUrl() {\n      return (\n        SettingMer.https +\n        `/upload/image/${this.tableData.attachment_category_id}/file`\n      );\n    }\n  },\n  watch: {\n    filterText(val) {\n      this.$refs.tree.filter(val);\n    }\n  },\n  mounted() {\n    this.params = this.$route && this.$route.path ? this.$route.path : \"\";\n    if (this.$route && this.$route.query.field === \"dialog\")\n      import(\"../../../public/UEditor/dialogs/internal\");\n    this.getList();\n    this.getFileList(\"\");\n  },\n  methods: {\n    // 搜索分类\n    filterNode(value, data) {\n      if (!value) return true;\n      return data.attachment_category_name.indexOf(value) !== -1;\n    },\n    // 所有分类\n    getList() {\n      const data = {\n        attachment_category_name: \"全部图片\",\n        attachment_category_id: 0\n      };\n      formatLstApi()\n        .then(res => {\n          this.treeData = res.data;\n          this.treeData.unshift(data);\n          this.treeData2 = [...this.treeData];\n        })\n        .catch(res => {\n          this.$message.error(res.message);\n        });\n    },\n    // 编辑图片名称\n    handleEdit(id, name) {\n      if (id === this.editId) {\n        if (this.editName !== name) {\n          if (!name.trim()) {\n            this.$message.warning(\"请先输入图片名称\");\n            return;\n          }\n          picNameEditApi(id, {\n            attachment_name: name\n          }).then(() => this.getFileList(\"\"));\n          this.editId = \"\";\n        } else {\n          this.editId = \"\";\n          this.editName = \"\";\n        }\n      } else {\n        this.editId = id;\n        this.editName = name;\n      }\n    },\n    // 添加分类\n    onAdd(id) {\n      const config = {};\n      if (Number(id) > 0)\n        config.formData = {\n          pid: id\n        };\n      this.$modalForm(attachmentCreateApi(), config).then(({ message }) => {\n        // this.$message.success(message)\n        this.getList();\n      });\n    },\n    // 编辑\n    onEdit(id) {\n      this.$modalForm(attachmentUpdateApi(id)).then(() => this.getList());\n    },\n    // 删除\n    handleDelete(id) {\n      this.$modalSure().then(() => {\n        attachmentDeleteApi(id)\n          .then(({ message }) => {\n            this.$message.success(message);\n            this.getList();\n          })\n          .catch(({ message }) => {\n            this.$message.error(message);\n          });\n      });\n    },\n    handleNodeClick(data) {\n      this.tableData.attachment_category_id = data.attachment_category_id;\n      this.getFileList(\"\");\n    },\n    // 上传成功\n    handleSuccess(response) {\n      if (response.status === 200) {\n        this.$message.success(\"上传成功\");\n        this.getFileList(\"\");\n      } else {\n        this.$message.error(response.message);\n      }\n    },\n    // 文件列表\n    getFileList(num) {\n      this.loading = true;\n      this.tableData.page = num ? num : this.tableData.page;\n      attachmentListApi(this.tableData)\n        .then(async res => {\n          this.pictrueList.list = res.data.list;\n          if (this.pictrueList.list.length) {\n            this.isShowPic = false;\n          } else {\n            this.isShowPic = true;\n          }\n          this.pictrueList.total = res.data.count;\n          if (\n            this.$route &&\n            this.$route.query.field &&\n            this.$route.query.field !== \"dialog\"\n          )\n            this.checkedMore =\n              window.form_create_helper.get(this.$route.query.field) || [];\n          this.loading = false;\n        })\n        .catch(res => {\n          this.$message.error(res.message);\n          this.loading = false;\n        });\n    },\n    pageChange(page) {\n      this.tableData.page = page;\n      this.selectItem = [];\n      this.checkPicList = [];\n      this.getFileList(\"\");\n    },\n    handleSizeChange(val) {\n      this.tableData.limit = val;\n      this.getFileList(\"\");\n    },\n    // 选中图片\n    changImage(item, index, row) {\n      // this.$set(item, 'isSelect', item.isSelect === undefined ? true : !item.isSelect)\n      // selectItem = this.pictrueList.list.filter((item) => {\n      //   return item.isSelect === true\n      // })\n      // this.ids = []\n      // const pic = []\n      // selectItem.map((item, index) => {\n      //   this.ids.push(item.attachment_id)\n      //   pic.push(item.attachment_src)\n      // })\n      // this.checkPicList = pic\n      if (!item.isSelect) {\n        item.isSelect = true;\n        this.selectItem.push(item);\n        this.checkPicList.push(item.attachment_src);\n        this.ids.push(item.attachment_id);\n      } else {\n        item.isSelect = false;\n        var index = this.ids.indexOf(item.attachment_id);\n        if (index > -1) this.ids.splice(index, 1);\n        this.selectItem.forEach((o, i) => {\n          if (o.attachment_id == item.attachment_id) {\n            this.selectItem.splice(i, 1);\n          }\n        });\n        this.checkPicList.map((el, index) => {\n          if (el == item.attachment_src) {\n            this.checkPicList.splice(index, 1);\n          }\n        });\n      }\n      if (\n        (this.$route &&\n          this.$route.fullPath &&\n          this.$route.fullPath !== \"/admin/config/picture\") ||\n        !this.$route\n      ) {\n        this.pictrueList.list.map((el, i) => {\n          if (el.isSelect) {\n            this.selectItem.filter((el2, j) => {\n              if (el.attachment_id == el2.attachment_id) {\n                el.num = j + 1;\n              }\n            });\n          } else {\n            el.num = 0;\n          }\n        });\n      }\n    },\n    // 点击使用选中图片\n    checkPics() {\n      if (this.checkPicList.length) {\n        if (this.$route) {\n          if (this.$route.query.type === \"1\") {\n            if (this.checkPicList.length > 1)\n              return this.$message.warning(\"最多只能选一张图片\");\n            /* eslint-disable */\n            form_create_helper.set(\n              this.$route.query.field,\n              this.checkPicList[0]\n            );\n            form_create_helper.close(this.$route.query.field);\n          }\n          if (this.$route.query.type === \"2\") {\n            this.checkedAll = [...this.checkedMore, ...this.checkPicList];\n            form_create_helper.set(\n              this.$route.query.field,\n              Array.from(new Set(this.checkedAll))\n            );\n            form_create_helper.close(this.$route.query.field);\n          }\n          if (this.$route.query.field === \"dialog\") {\n            let str = \"\";\n            for (let i = 0; i < this.checkPicList.length; i++) {\n              str += '<img src=\"' + this.checkPicList[i] + '\">';\n            }\n            /* eslint-disable */\n            nowEditor.editor.execCommand(\"insertHtml\", str);\n            nowEditor.dialog.close(true);\n            // nowEditor.editor.setContent(str, true)\n          }\n        } else {\n          if (this.isMore === \"1\" && this.checkPicList.length > 1) {\n            return this.$message.warning(\"最多只能选一张图片\");\n          }\n          this.$emit(\"getImage\", this.checkPicList);\n        }\n      } else {\n        this.$message.warning(\"请先选择图片\");\n      }\n    },\n    // 删除图片\n    editPicList(tit) {\n      const ids = {\n        ids: this.ids\n      };\n      this.$modalSure().then(() => {\n        picDeleteApi(ids)\n          .then(({ message }) => {\n            this.$message.success(message);\n            this.getFileList(\"\");\n            this.checkPicList = [];\n          })\n          .catch(({ message }) => {\n            this.$message.error(message);\n          });\n      });\n    },\n    // 移动分类点击\n    handleSelClick(node) {\n      if (this.ids.length) {\n        this.sleOptions = {\n          attachment_category_name: node.attachment_category_name,\n          attachment_category_id: node.attachment_category_id\n        };\n        this.getMove();\n      } else {\n        this.$message.warning(\"请先选择图片\");\n      }\n    },\n    getMove() {\n      categoryApi(this.ids, this.sleOptions.attachment_category_id)\n        .then(async res => {\n          this.$message.success(res.message);\n          this.clearBoth();\n          this.getFileList(\"\");\n        })\n        .catch(res => {\n          this.clearBoth();\n          this.$message.error(res.message);\n        });\n    },\n    clearBoth() {\n      this.sleOptions = {\n        attachment_category_name: \"\",\n        attachment_category_id: \"\"\n      };\n      this.checkPicList = [];\n      this.ids = [];\n    }\n  }\n};\n",null]}